#!/bin/bash

sudo rm -rf /tmp/gbuild-ninja.log /tmp/gbuild-meson.log /var/log/gbuild.log

log() {
    echo -e "$(date) -- $@" | sudo tee -a /var/log/gbuild.log
}

[ -z "$GBUILD_MESON_ARGS" ] && GBUILD_MESON_ARGS="--prefix=/usr --reconfigure"
[ -z "$GBUILD_NINJA_ARGS" ] && GBUILD_NINJA_ARGS=""
MESON_CMD="meson setup _build ${GBUILD_MESON_ARGS}"
NINJA_CMD="sudo ninja install -C _build ${GBUILD_NINJA_ARGS}"

REPO=$1
if ! echo $REPO | grep -q '/'; then
    REPO="GNOME/$1"
    log "Redirecting $1 to ${REPO}"
fi
shift

set -eo pipefail

t1=$(date +%s%N)

cd ${HOME}/.local/src

if [ $# -gt 0 ] && [ $1 = "--clean" ] || [ $CLEAN ]; then
    log "Cleaning ${HOME}/.local/src/${REPO}"
    sudo rm -rf ${HOME}/.local/src/${REPO}
fi

if [ -d ${HOME}/.local/src/${REPO} ]; then
    log "Updating ${REPO}"
    cd ${REPO}
    git pull --quiet
else
    log "Cloning ${REPO}"
    git clone --quiet --depth 1 "https://gitlab.gnome.org/${REPO}" ${REPO}
    cd ${REPO}
fi

# [ -f ./autogen.sh ] && ./autogen.sh
# [ -f ./configure ] && ./configure

if [ ${REPO} = "GNOME/gobject-introspection" ]; then
    if [ -d ./gobject-introspection-tests/.git ]; then
        cd ./gobject-introspection-tests
        log "Updating GNOME/gobject-introspection-tests"
        git pull --quiet
    else
        log "Cloning GNOME/gobject-introspection-tests"
        git clone --quiet --depth 1 "https://gitlab.gnome.org/GNOME/gobject-introspection-tests"
        cd ./gobject-introspection-tests
    fi

    log "Configuring GNOME/gobject-introspection-tests"
    if ! sudo bash -c "unbuffer ${MESON_CMD} &> /tmp/gbuild-meson.log"; then
        t2=$(date +%s%N)
        delta=$(echo "scale=4;($t2-$t1)/1000000000.0" | bc)
        log "Configuration of GNOME/gobject-introspection-tests failed at ${delta}s\n"
        cat /tmp/gbuild-meson.log
        exit 1
    fi

    log "Building GNOME/gobject-introspection-tests"
    if ! sudo bash -c "unbuffer ${NINJA_CMD} &> /tmp/gbuild-ninja.log"; then
        t2=$(date +%s%N)
        delta=$(echo "scale=4;($t2-$t1)/1000000000.0" | bc)
        log "Building of GNOME/gobject-introspection-tests failed at ${delta}s\n"
        cat /tmp/gbuild-ninja.log
        exit 1
    fi

    cd ..
fi

log "Configuring ${REPO}"
if ! bash -c "unbuffer ${MESON_CMD}" |& sudo tee /tmp/gbuild-meson.log &>/dev/null; then
    t2=$(date +%s%N)
    delta=$(echo "scale=4;($t2-$t1)/1000000000.0" | bc)
    log "Configuration of ${REPO} failed at ${delta}s\n"
    cat /tmp/gbuild-meson.log
    exit 1
fi

log "Building ${REPO}"
if ! sudo bash -c "unbuffer ${NINJA_CMD} &> /tmp/gbuild-ninja.log"; then
    t2=$(date +%s%N)
    delta=$(echo "scale=4;($t2-$t1)/1000000000.0" | bc)
    log "Building of ${REPO} failed at ${delta}s\n"
    cat /tmp/gbuild-ninja.log
    exit 1
fi

t2=$(date +%s%N)
delta=$(echo "scale=4;($t2-$t1)/1000000000.0" | bc)

log "Built ${REPO} in ${delta}s\n"
